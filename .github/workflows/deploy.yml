# ============================================
# GitHub Actions - CI/CD AstroEngine API
# Deploy automático na OCI via SSH + Docker
# ============================================

name: Deploy AstroEngine API

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/ubuntu/astroengine-api

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        run: |
          pip install -r requirements.txt
          pip install pytest httpx

      - name: Executar testes
        env:
          API_KEY: test-key
          RATE_LIMIT: "100"
          CORS_ORIGINS: "*"
        run: python -m pytest tests/ -v

  deploy:
    name: Deploy to OCI
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            DEPLOY_DIR=/home/ubuntu/astroengine-api

            echo "=== Atualizando código ==="
            cd $DEPLOY_DIR
            git pull origin main

            echo "=== Configurando API_KEYS ==="
            export API_KEYS=dev-key-cosmic-suite

            echo "=== Rebuild do container ==="
            cd $DEPLOY_DIR
            docker compose build
            docker compose up -d

            echo "=== Aguardando health check ==="
            sleep 10
            curl -sf http://localhost:8000/health && echo " AstroEngine API OK!" || echo "AVISO: Health check falhou"

            echo "=== Deploy concluído ==="
